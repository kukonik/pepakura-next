# Архитектура системы развертки для Pepakura Next

## Обзор

Этот документ описывает архитектуру улучшенной системы развертки (unfold) для приложения Pepakura Next. Система преобразует 3D-модели в 2D-шаблоны, которые можно распечатать и собрать в бумажные модели.

## Текущее состояние

На данный момент система развертки использует заглушку, которая создает тестовые данные вместо реального алгоритма развертки. Основные компоненты:

1. **Фронтенд (Vue.js/Tauri)**:
   - Компонент `UnfoldStage.vue` для отображения параметров и предварительного просмотра
   - Хранилище `project.ts` для управления состоянием развертки
   - Вызовы Tauri команд для взаимодействия с бэкендом

2. **Бэкенд (Rust/Tauri)**:
   - Модуль `unfold` с типами данных и движком развертки
   - Команда `unfold_3d_model` в `main.rs` для обработки запросов
   - Заглушка `compute_unfold_stub` вместо реального алгоритма

## Области для улучшения

1. **Алгоритм развертки**:
   - Заменить заглушку на реальный алгоритм развертки 3D моделей
   - Реализовать правильное разбиение на грани и их развертку
   - Добавить алгоритмы упаковки деталей на листы

2. **Интерфейс пользователя**:
   - Добавить визуализацию реальных разверток
   - Реализовать интерактивное редактирование разверток
   - Добавить настройки для клапанов и линий сгиба

3. **Производительность**:
   - Оптимизировать алгоритмы для работы с большими моделями
   - Добавить асинхронную обработку для отзывчивого интерфейса

## Предлагаемая архитектура

### 1. Улучшенный алгоритм развертки

#### Компоненты:
- **UnfoldEngine**: Основной движок развертки
- **FaceUnfolder**: Обработчик отдельных граней
- **LayoutOptimizer**: Оптимизатор размещения деталей на листах
- **SheetPacker**: Упаковщик деталей на листы

#### Алгоритм:
1. **Анализ модели**:
   - Загрузка 3D модели (OBJ/MTL)
   - Построение графа смежности граней
   - Определение цепочек граней для развертки

2. **Развертка граней**:
   - Преобразование 3D треугольников в 2D полигоны
   - Добавление клапанов для соединения
   - Расчет линий сгиба (долинные/горные)

3. **Оптимизация размещения**:
   - Упаковка деталей на листы с минимальными отходами
   - Избегание пересечений деталей
   - Учет полей печати

### 2. Улучшенный интерфейс

#### Новые функции:
- **Визуализация развертки**:
  - Отображение реальных 2D шаблонов
  - Цветовое кодирование линий (рез, долина, гора, клапан)
  - Масштабирование и панорамирование

- **Интерактивное редактирование**:
  - Перемещение деталей на листах
  - Ручная настройка клапанов
  - Добавление номеров и надписей

- **Экспорт**:
  - Экспорт в PDF с правильными размерами
  - Экспорт в SVG для редактирования
  - Экспорт в PNG для предварительного просмотра

### 3. Интеграция с существующей кодовой базой

#### Изменения в бэкенде (Rust):
1. Заменить `compute_unfold_stub` на реальную реализацию
2. Добавить зависимости для работы с 3D моделями:
   - `nalgebra` для математических операций
   - `petgraph` для работы с графами
   - `svg` для генерации SVG

#### Изменения во фронтенде (Vue):
1. Обновить `UnfoldStage.vue` для отображения реальных данных
2. Добавить компоненты для визуализации развертки
3. Реализовать интерактивные элементы управления

## Дорожная карта реализации

### Этап 1: Базовый алгоритм развертки (2 недели)
- Реализовать UnfoldEngine с базовым алгоритмом
- Добавить развертку треугольников в 2D
- Реализовать простую упаковку на листы

### Этап 2: Улучшенный алгоритм (3 недели)
- Добавить алгоритмы оптимизации размещения
- Реализовать правильные клапаны и линии сгиба
- Добавить поддержку различных форматов бумаги

### Этап 3: Интерфейс пользователя (2 недели)
- Обновить UnfoldStage для отображения реальных данных
- Добавить визуализацию 2D шаблонов
- Реализовать базовые инструменты редактирования

### Этап 4: Расширенные функции (2 недели)
- Добавить интерактивное редактирование
- Реализовать экспорт в различные форматы
- Добавить настройки для печати

### Этап 5: Оптимизация и тестирование (1 неделя)
- Оптимизировать производительность
- Добавить тесты
- Исправить найденные ошибки

## Технические детали

### Типы данных

```rust
// Расширенные типы для развертки
pub struct UnfoldedFace {
    pub face_id: u32,
    pub polygon: Vec<Point2D>,
    pub bounds: Rect,
    pub lines: Vec<Line2D>,
    pub connections: Vec<FaceConnection>,
}

pub struct FaceConnection {
    pub face_id: u32,
    pub edge_index: u32,
    pub kind: ConnectionKind,
}

pub enum ConnectionKind {
    GlueTab,
    ValleyFold,
    MountainFold,
}
```

### Алгоритмы

1. **Развертка Уоллеса-Блейка** для преобразования 3D граней в 2D
2. **Алгоритм Ниренберга** для определения цепочек граней
3. **Алгоритм упаковки сначала по наилучшему соответствию** для размещения деталей

## Заключение

Эта архитектура обеспечивает четкий путь к созданию полнофункциональной системы развертки для Pepakura Next. Реализация будет разделена на управляемые этапы, что позволит постепенно улучшать функциональность приложения и обеспечить высокое качество конечного продукта.
